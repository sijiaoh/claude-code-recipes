# Phaser.js 游戏开发最佳实践

本文件定义了 Phaser.js 游戏开发的特定规范和最佳实践，遵循 Phaser 社区广泛认同的标准。

**重要**: 使用 Phaser.js 开发时，必须同时遵守：
- `base.md` - 通用编程最佳实践
- `oop.md` - 面向对象编程原则（推荐使用）
- `typescript.md` - TypeScript 语言最佳实践（强烈推荐）
- 本文件中的 Phaser.js 特定规范

## 核心原则

### 1. 开发语言优先级
- **TypeScript 优先**: 强烈推荐使用 TypeScript 开发，充分利用类型系统
- **接口定义**: 为游戏对象、配置、数据结构定义清晰的接口
- **类型安全**: 避免使用 any 类型，确保类型安全

### 2. 项目结构组织
- **场景分离**: 每个游戏场景对应独立的类文件
- **功能模块化**: 按功能划分目录（scenes、objects、components、managers、config、utils）
- **资源集中管理**: 建立统一的资源管理系统
- **配置外部化**: 游戏配置、关卡数据、平衡性参数应外部化管理

### 3. 面向对象设计
- **严格遵循 oop.md**: 按照面向对象编程最佳实践进行设计
- **组合优于继承**: 优先使用组件系统而非深度继承
- **单一职责**: 每个类应有明确的职责

## 场景管理

### 场景生命周期
- **明确职责分工**: 每个场景有清晰的责任边界
- **资源生命周期**: 在正确的生命周期方法中加载和释放资源
- **数据验证**: 对场景间传递的数据进行验证
- **状态管理**: 合理管理场景状态和场景间的数据传递

### 场景间通信
- **事件驱动**: 使用 Phaser 事件系统进行场景间通信
- **数据传递**: 通过 scene.start() 传递必要数据，避免全局变量
- **全局状态**: 使用单例模式管理全局游戏状态
- **状态持久化**: 合理处理游戏状态的保存和恢复

## 游戏对象设计

### 设计原则
- **组件化架构**: 使用组件系统构建游戏对象
- **接口抽象**: 定义清晰的游戏对象接口
- **职责单一**: 每个组件只负责特定功能
- **松耦合**: 组件间保持松耦合关系

### 游戏对象生命周期
- **初始化**: 明确对象的初始化流程
- **更新**: 合理实现对象的更新逻辑
- **销毁**: 确保对象正确清理资源

## 资源管理

### 加载策略
- **分层加载**: 核心资源预加载，场景资源按需加载
- **加载优化**: 合理安排资源加载时机和顺序
- **进度反馈**: 为资源加载提供进度反馈
- **错误处理**: 妥善处理资源加载失败情况

### 纹理和动画
- **纹理图集**: 优先使用纹理图集减少绘制调用
- **动画配置**: 将动画配置数据外部化
- **内存优化**: 合理使用纹理压缩和分辨率
- **资源复用**: 最大化资源复用，避免重复加载

### 资源释放
- **及时释放**: 不再使用的资源应及时释放
- **内存监控**: 监控内存使用情况
- **缓存策略**: 建立合理的资源缓存策略

## 物理系统

### 引擎选择
- **需求匹配**: 根据游戏需求选择合适的物理引擎（Arcade Physics vs Matter.js）
- **性能考虑**: 考虑物理计算对性能的影响
- **功能需求**: 评估所需的物理功能复杂度

### 碰撞检测
- **碰撞组**: 使用碰撞组和掩码优化性能
- **检测范围**: 限制碰撞检测范围
- **精度平衡**: 在精度和性能间找到平衡

### 物理属性设置
- **合理参数**: 设置合理的物理属性避免性能问题
- **调试支持**: 提供物理调试显示功能

## 输入管理

### 输入抽象
- **多设备支持**: 支持键盘、鼠标、触摸、手柄等多种输入设备
- **输入映射**: 提供可配置的按键映射功能
- **输入状态**: 正确管理输入状态（按下、释放、长按等）

### 输入处理
- **事件驱动**: 使用事件驱动的输入处理模式
- **优先级**: 建立输入处理的优先级机制
- **防抖处理**: 对频繁触发的输入进行防抖处理

## 音频系统

### 音频管理
- **分类管理**: 分别管理音乐和音效
- **音频池**: 使用音频池管理音效播放
- **音量控制**: 提供独立的音乐和音效音量控制
- **格式兼容**: 提供多种音频格式支持跨浏览器兼容

### 音频优化
- **内存管理**: 合理管理音频资源的加载和释放
- **播放优化**: 避免同时播放过多音效
- **音频压缩**: 使用合适的音频压缩格式

## 性能优化

### 渲染优化
- **对象池**: 使用对象池技术减少垃圾回收
- **可见性检测**: 只渲染和更新可见区域内的对象
- **批量操作**: 使用 Groups 进行批量渲染和更新
- **LOD**: 根据距离实现细节层次（Level of Detail）

### 内存优化
- **内存监控**: 定期监控内存使用情况
- **及时清理**: 及时销毁不再使用的对象
- **事件清理**: 正确移除事件监听器
- **纹理复用**: 重复使用纹理资源

### 更新优化
- **帧率控制**: 合理控制游戏帧率
- **更新频率**: 根据需要调整不同对象的更新频率
- **计算优化**: 避免在每帧进行复杂计算

## 调试和测试

### 调试支持
- **调试模式**: 提供可切换的调试显示功能
- **性能监控**: 集成 FPS、内存使用等性能监控
- **状态显示**: 显示关键游戏状态和对象信息
- **日志系统**: 建立结构化的日志系统

### 测试实践
- **单元测试**: 为关键逻辑编写单元测试
- **集成测试**: 测试游戏模块间的集成
- **性能测试**: 定期进行性能基准测试

## 配置管理

### 配置分离
- **环境配置**: 区分开发、测试、生产环境配置
- **游戏配置**: 将游戏平衡、难度等数据外部化
- **本地化**: 支持多语言和地区化配置

### 配置加载
- **动态加载**: 支持运行时动态加载配置
- **版本管理**: 建立配置版本管理机制
- **默认值**: 为所有配置项提供合理默认值

## 发布和部署

### 构建优化
- **资源压缩**: 压缩图片、音频等资源文件
- **代码压缩**: 使用代码压缩和混淆
- **缓存策略**: 建立合理的浏览器缓存策略

### 平台适配
- **响应式设计**: 适配不同屏幕尺寸和分辨率
- **性能分级**: 根据设备性能提供不同质量选项
- **兼容性**: 确保跨浏览器和平台兼容性

---

*本规范应该与具体的游戏项目需求相结合，在遵循 Phaser.js 最佳实践的基础上保持适当的灵活性。*